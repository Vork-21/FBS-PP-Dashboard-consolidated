{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-chart-line me-3"></i>Payment Projections</h1>
            <div class="d-flex gap-2">
                <button class="btn btn-success" onclick="exportProjections()">
                    <i class="fas fa-file-excel me-2"></i>Export Projections
                </button>
                <button class="btn btn-outline-primary" onclick="refreshProjections()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card bg-info">
            <div class="metric-value" id="totalExpectedMonthly">$0</div>
            <div class="metric-label">Expected Monthly</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card bg-success">
            <div class="metric-value" id="onTrackPlans">0</div>
            <div class="metric-label">On Track Plans</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card bg-warning">
            <div class="metric-value" id="behindPlans">0</div>
            <div class="metric-label">Behind Plans</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card bg-primary">
            <div class="metric-value" id="avgCompletionMonths">0</div>
            <div class="metric-label">Avg Completion (Months)</div>
        </div>
    </div>
</div>

<!-- Settings -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calendar me-2"></i>Projection Settings</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Time Range</label>
                        <select class="form-select" id="timeRange" onchange="updateProjections()">
                            <option value="6">Next 6 Months</option>
                            <option value="12" selected>Next 12 Months</option>
                            <option value="24">Next 24 Months</option>
                            <option value="36">Next 36 Months</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Class Filter</label>
                        <select class="form-select" id="classFilter" onchange="updateProjections()">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Customer Scenario</label>
                        <select class="form-select" id="scenarioSelect" onchange="updateProjections()">
                            <option value="current">Current Status</option>
                            <option value="restart">If Restarted Today</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">View Type</label>
                        <select class="form-select" id="viewType" onchange="toggleViews()">
                            <option value="overview">Overview Charts</option>
                            <option value="customers">Customer Timeline</option>
                            <option value="both" selected>Both Views</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
<div id="loadingIndicator" class="text-center py-4" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading projections...</span>
    </div>
    <div class="mt-2">Calculating payment projections...</div>
</div>

<!-- Overview Section -->
<div id="overviewSection">
    <!-- Portfolio Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Monthly Payment Projections</h5>
                </div>
                <div class="card-body">
                    <canvas id="portfolioChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Schedule Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Monthly Payment Schedule</h5>
                        <span class="badge bg-info" id="totalProjectedBadge">$0 Total</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Expected Payments</th>
                                    <th>Active Customers</th>
                                    <th>Completing</th>
                                    <th>Cumulative Total</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyScheduleTable">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Customer Timeline Section -->
<div id="customerSection">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-users-clock me-2"></i>Customer Payment Timeline</h5>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control" id="customerSearch" placeholder="Search customers..." style="width: 250px;">
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearCustomerSearch()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="customerTimelineContainer">
                        <!-- Customer timeline will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let portfolioChart = null;
    let currentProjectionData = null;
    let currentPortfolioData = null;
    let renegotiationCandidates = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadClassOptions();
        updateProjections();
        setupCustomerSearch();
    });

    async function loadClassOptions() {
        try {
            const response = await fetch('/api/classes');
            const data = await response.json();
            
            const classFilter = document.getElementById('classFilter');
            data.classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classFilter.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading classes:', error);
        }
    }

    async function updateProjections() {
        const timeRange = document.getElementById('timeRange').value;
        const classFilter = document.getElementById('classFilter').value;
        const scenario = document.getElementById('scenarioSelect').value;

        showLoading(true);

        try {
            // Load summary data with scenario info
            await loadSummaryData(timeRange, scenario);
            
            // Load portfolio data
            await loadPortfolioData(timeRange, scenario, classFilter);
            
            // Load customer data
            await loadCustomerData(timeRange, scenario, classFilter);
            
            // FIXED: Show renegotiation alerts if needed
            await analyzeRenegotiationNeeds(scenario);
            
        } catch (error) {
            console.error('Error updating projections:', error);
            showToast('Error loading projections', 'danger');
        } finally {
            showLoading(false);
        }
    }

    async function loadSummaryData(months, scenario) {
        const response = await fetch(`/api/projections/summary?months=${months}&scenario=${scenario}`);
        const data = await response.json();
        
        // FIXED: Show whole numbers only
        document.getElementById('totalExpectedMonthly').textContent = formatCurrency(data.total_expected_monthly);
        document.getElementById('onTrackPlans').textContent = data.on_track_customers;
        document.getElementById('behindPlans').textContent = data.behind_customers;
        document.getElementById('avgCompletionMonths').textContent = Math.ceil(data.average_completion_months || 0);
    }

    async function loadPortfolioData(months, scenario, classFilter) {
        const params = new URLSearchParams({
            months: months,
            scenario: scenario
        });
        
        if (classFilter) {
            params.append('class_filter', classFilter);
        }

        const response = await fetch(`/api/projections/portfolio?${params}`);
        currentPortfolioData = await response.json();
        
        updatePortfolioChart();
        updateMonthlyScheduleTable();
    }

    async function loadCustomerData(months, scenario, classFilter) {
        const params = new URLSearchParams({
            months: months,
            scenario: scenario
        });
        
        if (classFilter) {
            params.append('class_filter', classFilter);
        }

        const response = await fetch(`/api/projections/customers?${params}`);
        currentProjectionData = await response.json();
        
        updateCustomerTimeline();
    }

    async function analyzeRenegotiationNeeds(scenario) {
        /**
         * FIXED: Analyze which customers need renegotiation contact
         * This helps identify customers who should be excluded from projections
         * until they're contacted and new terms are established
         */
        
        if (!currentProjectionData) return;
        
        // Identify customers with renegotiation needs
        renegotiationCandidates = currentProjectionData.filter(customer => {
            return customer.renegotiation_needed || customer.status === 'behind';
        });
        
        // Show renegotiation alert if there are candidates
        if (renegotiationCandidates.length > 0 && scenario === 'current') {
            showRenegotiationAlert();
        }
    }

    function showRenegotiationAlert() {
        const alertContainer = document.getElementById('renegotiationAlert');
        if (alertContainer) {
            alertContainer.remove(); // Remove existing alert
        }
        
        const alertHtml = `
            <div id="renegotiationAlert" class="alert alert-warning alert-dismissible fade show mb-4" role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning me-3"></i>
                    <div class="flex-grow-1">
                        <h5 class="alert-heading mb-2">
                            <strong>${renegotiationCandidates.length} Customers Need Contact</strong>
                        </h5>
                        <p class="mb-2">
                            These customers are significantly behind and should be contacted to renegotiate payment terms 
                            before including them in reliable projections.
                        </p>
                        <div class="mt-3">
                            <button class="btn btn-warning btn-sm me-2" onclick="showRenegotiationList()">
                                <i class="fas fa-list me-1"></i>View List
                            </button>
                            <button class="btn btn-outline-warning btn-sm me-2" onclick="switchToRenegotiationScenario()">
                                <i class="fas fa-handshake me-1"></i>Show Renegotiation Scenarios
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="excludeBehindCustomers()">
                                <i class="fas fa-eye-slash me-1"></i>Exclude from Projections
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        // Insert after summary cards
        const summaryRow = document.querySelector('.row.mb-4');
        summaryRow.insertAdjacentHTML('afterend', alertHtml);
    }

    function showRenegotiationList() {
        const modalHtml = `
            <div class="modal fade" id="renegotiationModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Customers Requiring Renegotiation Contact
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <strong>Action Required:</strong> These customers are significantly behind on payments. 
                                Contact them to discuss payment plan modifications before including in projections.
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Priority</th>
                                            <th>Customer</th>
                                            <th>Months Behind</th>
                                            <th>Current Balance</th>
                                            <th>Current Monthly</th>
                                            <th>Suggested Monthly</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${renegotiationCandidates.map((customer, index) => {
                                            const suggestedMonthly = customer.total_owed / 30; // 30-month plan
                                            const priority = customer.months_behind >= 6 ? 'High' : 
                                                           customer.months_behind >= 3 ? 'Medium' : 'Low';
                                            const priorityClass = customer.months_behind >= 6 ? 'danger' : 
                                                                customer.months_behind >= 3 ? 'warning' : 'info';
                                            
                                            return `
                                                <tr>
                                                    <td>
                                                        <span class="badge bg-${priorityClass}">${priority}</span>
                                                    </td>
                                                    <td>
                                                        <strong>${customer.customer_name}</strong>
                                                        <br><small class="text-muted">${customer.plan_count} plan(s)</small>
                                                    </td>
                                                    <td>
                                                        <span class="text-danger fw-bold">${customer.months_behind}</span>
                                                        <br><small class="text-muted">months</small>
                                                    </td>
                                                    <td>
                                                        <span class="fw-bold">${formatCurrency(customer.total_owed)}</span>
                                                    </td>
                                                    <td>
                                                        <span class="text-primary">${formatCurrency(customer.total_monthly_payment)}</span>
                                                    </td>
                                                    <td>
                                                        <span class="text-success">${formatCurrency(suggestedMonthly)}</span>
                                                        <br><small class="text-muted">30-month plan</small>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary" 
                                                                onclick="showCustomerDetails('${customer.customer_name}')">
                                                            <i class="fas fa-eye"></i> Details
                                                        </button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-warning" onclick="exportRenegotiationList()">
                                <i class="fas fa-download me-2"></i>Export Contact List
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('renegotiationModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add new modal
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('renegotiationModal'));
        modal.show();
    }

    function switchToRenegotiationScenario() {
        document.getElementById('scenarioSelect').value = 'renegotiate';
        updateProjections();
    }

    function excludeBehindCustomers() {
        // This would filter out behind customers from projections
        // For now, just switch to restart scenario which is more optimistic
        document.getElementById('scenarioSelect').value = 'restart';
        updateProjections();
        showToast('Showing projections excluding behind customers (restart scenario)', 'info');
    }

    function updatePortfolioChart() {
        if (!currentPortfolioData) return;

        const ctx = document.getElementById('portfolioChart');
        
        if (portfolioChart) {
            portfolioChart.destroy();
        }

        const monthlyData = currentPortfolioData.monthly_projections;
        const scenario = document.getElementById('scenarioSelect').value;
        
        // FIXED: Add context about behind customers to chart
        let chartTitle = 'Portfolio Payment Projections';
        if (scenario === 'current') {
            chartTitle += ' (Current Behavior)';
        } else if (scenario === 'restart') {
            chartTitle += ' (Fresh Start Scenario)';
        } else if (scenario === 'renegotiate') {
            chartTitle += ' (Renegotiated Terms)';
        }
        
        portfolioChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthlyData.map(month => {
                    const date = new Date(month.date);
                    return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                }),
                datasets: [{
                    label: 'Expected Monthly Payments',
                    data: monthlyData.map(month => month.expected_payment),
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Behind Customers',
                    data: monthlyData.map(month => month.behind_customers * 100), // Scale for visibility
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.4,
                    fill: false,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Payment Amount ($)'
                        },
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Behind Customers Count'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                        ticks: {
                            callback: function(value) {
                                return Math.round(value / 100); // Unscale
                            }
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: chartTitle
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.datasetIndex === 0) {
                                    return 'Expected: ' + formatCurrency(context.parsed.y);
                                } else {
                                    return 'Behind Customers: ' + Math.round(context.parsed.y / 100);
                                }
                            }
                        }
                    }
                }
            }
        });
    }

    function updateMonthlyScheduleTable() {
        if (!currentPortfolioData) return;

        const tbody = document.getElementById('monthlyScheduleTable');
        const monthlyData = currentPortfolioData.monthly_projections;
        
        const totalExpected = currentPortfolioData.summary.total_expected_collection;
        document.getElementById('totalProjectedBadge').textContent = formatCurrency(totalExpected) + ' Total';

        tbody.innerHTML = monthlyData.map(month => {
            const date = new Date(month.date);
            const monthName = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            
            // FIXED: Show behind customers count
            const behindCount = month.behind_customers || 0;
            
            return `
                <tr>
                    <td><strong>${monthName}</strong></td>
                    <td>
                        <span class="text-success fw-bold">${formatCurrency(month.expected_payment)}</span>
                        ${behindCount > 0 ? `<br><small class="text-warning">${behindCount} behind customers</small>` : ''}
                    </td>
                    <td><span class="badge bg-info">${month.active_customers}</span></td>
                    <td><span class="badge bg-warning">${month.completing_customers}</span></td>
                    <td><span class="text-secondary">${formatCurrency(month.cumulative_total)}</span></td>
                </tr>
            `;
        }).join('');
    }

    function updateCustomerTimeline() {
        if (!currentProjectionData) return;

        const container = document.getElementById('customerTimelineContainer');
        
        // Apply search filter
        const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
        let filteredData = currentProjectionData;
        
        if (searchTerm) {
            filteredData = currentProjectionData.filter(customer => 
                customer.customer_name.toLowerCase().includes(searchTerm)
            );
        }

        // FIXED: Sort by status first (behind customers on top), then by payment amount
        filteredData.sort((a, b) => {
            // Behind customers first
            const aRenegotiation = a.renegotiation_needed ? 0 : 1;
            const bRenegotiation = b.renegotiation_needed ? 0 : 1;
            
            if (aRenegotiation !== bRenegotiation) {
                return aRenegotiation - bRenegotiation;
            }
            
            // Then by payment amount
            return b.total_monthly_payment - a.total_monthly_payment;
        });

        if (filteredData.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    No customers found matching your search criteria.
                </div>
            `;
            return;
        }

        let html = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Status</th>
                            <th>Monthly Payment</th>
                            <th>Total Owed</th>
                            <th>Plans</th>
                            <th>Completion</th>
                            <th>Payment Schedule</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        filteredData.forEach((customer, index) => {
            const completionText = customer.completion_month > 0 ? 
                `${customer.completion_month} months` : 'Requires Contact';
            
            // Show upcoming payment months
            const paymentMonths = customer.timeline
                .filter(month => month.monthly_payment > 0)
                .slice(0, 6)
                .map(month => `<span class="badge bg-success me-1" title="Month ${month.month}: ${formatCurrency(month.monthly_payment)}">${month.month}</span>`)
                .join('');

            // FIXED: Status display with behind information
            let statusBadge = '';
            let statusClass = 'table-row';
            
            if (customer.renegotiation_needed) {
                statusBadge = `<span class="badge bg-danger">Needs Contact</span><br><small class="text-muted">${customer.months_behind} months behind</small>`;
                statusClass = 'table-danger';
            } else if (customer.status === 'behind') {
                statusBadge = `<span class="badge bg-warning">Behind</span><br><small class="text-muted">${customer.months_behind} months</small>`;
                statusClass = 'table-warning';
            } else if (customer.status === 'restart') {
                statusBadge = '<span class="badge bg-info">Restart Scenario</span>';
            } else if (customer.status === 'renegotiate') {
                statusBadge = '<span class="badge bg-primary">Renegotiated</span>';
            } else {
                statusBadge = '<span class="badge bg-success">Current</span>';
            }

            html += `
                <tr class="${statusClass}">
                    <td>
                        <strong>${customer.customer_name}</strong>
                        <br><small class="text-muted">${customer.plan_count} payment plan${customer.plan_count > 1 ? 's' : ''}</small>
                    </td>
                    <td>${statusBadge}</td>
                    <td>
                        <span class="text-success fw-bold">${formatCurrency(customer.total_monthly_payment)}</span>
                        <br><small class="text-muted">per payment</small>
                    </td>
                    <td>
                        <span class="fw-bold">${formatCurrency(customer.total_owed)}</span>
                    </td>
                    <td>
                        <span class="badge bg-info">${customer.plan_count}</span>
                    </td>
                    <td>
                        <span class="badge ${customer.completion_month <= 12 ? 'bg-success' : customer.completion_month <= 24 ? 'bg-warning' : 'bg-info'}">
                            ${completionText}
                        </span>
                    </td>
                    <td>
                        <div class="d-flex flex-wrap gap-1">
                            ${paymentMonths || '<span class="text-muted">Contact needed</span>'}
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showCustomerDetails('${customer.customer_name}')">
                            <i class="fas fa-eye"></i> Details
                        </button>
                        ${customer.renegotiation_needed ? 
                            `<br><button class="btn btn-sm btn-warning mt-1" onclick="suggestRenegotiation('${customer.customer_name}')">
                                <i class="fas fa-handshake"></i> Renegotiate
                            </button>` : ''}
                    </td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        container.innerHTML = html;
    }

    // FIXED: Add renegotiation suggestion function
    function suggestRenegotiation(customerName) {
        const customer = currentProjectionData.find(c => c.customer_name === customerName);
        if (!customer) return;
        
        const suggestedMonthly = customer.total_owed / 30; // 30-month plan
        
        const modalHtml = `
            <div class="modal fade" id="renegotiationSuggestionModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title">
                                <i class="fas fa-handshake me-2"></i>
                                Renegotiation Suggestion: ${customerName}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <strong>Current Situation:</strong> Customer is ${customer.months_behind} months behind on payments.
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Current Terms:</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Monthly Payment:</strong> ${formatCurrency(customer.total_monthly_payment)}</li>
                                        <li><strong>Total Owed:</strong> ${formatCurrency(customer.total_owed)}</li>
                                        <li><strong>Months Behind:</strong> ${customer.months_behind}</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Suggested New Terms:</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>New Monthly:</strong> ${formatCurrency(suggestedMonthly)}</li>
                                        <li><strong>Term:</strong> 30 months</li>
                                        <li><strong>Fresh Start:</strong> Reset to current</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="alert alert-success">
                                <strong>Benefits:</strong> Lower monthly payment, fresh start, predictable completion timeline.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="exportCustomerRenegotiation('${customerName}')">
                                <i class="fas fa-download me-2"></i>Export Proposal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('renegotiationSuggestionModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add new modal
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('renegotiationSuggestionModal'));
        modal.show();
    }

    // Add other existing functions (showCustomerDetails, etc.) but with FIXED whole number handling

    function exportRenegotiationList() {
        const csvData = [
            ['Customer', 'Months Behind', 'Current Balance', 'Current Monthly', 'Suggested Monthly', 'Priority']
        ];
        
        renegotiationCandidates.forEach(customer => {
            const suggestedMonthly = customer.total_owed / 30;
            const priority = customer.months_behind >= 6 ? 'High' : 
                            customer.months_behind >= 3 ? 'Medium' : 'Low';
            
            csvData.push([
                customer.customer_name,
                customer.months_behind, // Already whole number
                customer.total_owed,
                customer.total_monthly_payment,
                suggestedMonthly,
                priority
            ]);
        });
        
        // Convert to CSV and download
        const csvString = csvData.map(row => row.join(',')).join('\n');
        const blob = new Blob([csvString], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `renegotiation_candidates_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
        
        showToast('Renegotiation list exported successfully', 'success');
    }

    // Keep other existing functions but ensure they use whole numbers...
    // (showCustomerDetails, setupCustomerSearch, etc.)

    function setupCustomerSearch() {
        const searchInput = document.getElementById('customerSearch');
        let searchTimeout;
        
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                updateCustomerTimeline();
            }, 300);
        });
    }

    function clearCustomerSearch() {
        document.getElementById('customerSearch').value = '';
        updateCustomerTimeline();
    }

    function toggleViews() {
        const viewType = document.getElementById('viewType').value;
        const overviewSection = document.getElementById('overviewSection');
        const customerSection = document.getElementById('customerSection');
        
        if (viewType === 'overview') {
            overviewSection.style.display = 'block';
            customerSection.style.display = 'none';
        } else if (viewType === 'customers') {
            overviewSection.style.display = 'none';
            customerSection.style.display = 'block';
        } else {
            overviewSection.style.display = 'block';
            customerSection.style.display = 'block';
        }
    }

    function showLoading(show) {
        document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
    }

    async function exportProjections() {
        try {
            const response = await fetch('/api/download/excel');
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'payment_projections.xlsx';
                a.click();
                window.URL.revokeObjectURL(url);
                showToast('Projections exported successfully', 'success');
            } else {
                throw new Error('Export failed');
            }
        } catch (error) {
            console.error('Export error:', error);
            showToast('Error exporting projections', 'danger');
        }
    }

    async function refreshProjections() {
        showToast('Refreshing projections...', 'info');
        await updateProjections();
        showToast('Projections refreshed', 'success');
    }

    // FIXED: Currency formatting with no decimals for whole dollar amounts
    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(amount);
    }

    function showToast(message, type) {
        console.log(`${type.toUpperCase()}: ${message}`);
        // Implementation would depend on your existing toast system
    }
</script>
{% endblock %}