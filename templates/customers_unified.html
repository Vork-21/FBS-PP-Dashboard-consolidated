{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-users me-3"></i>Customer Payment Tracking & Projections</h1>
            <div class="d-flex gap-2">
                <button class="btn btn-info" onclick="toggleProjectionsView()">
                    <i class="fas fa-chart-line me-2"></i><span id="toggleProjectionsText">Show Projections</span>
                </button>
                <button class="btn btn-success" onclick="downloadCustomerData()">
                    <i class="fas fa-download me-2"></i>Export Data
                </button>
                <button class="btn btn-outline-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Controls and Filters -->
<div class="row mb-4">
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filters & Search</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Search Customers</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchCustomer" placeholder="Customer name...">
                            <button class="btn btn-outline-secondary" onclick="clearSearch()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="statusFilter" onchange="applyFilters()">
                            <option value="all">All Statuses</option>
                            <option value="current">Current</option>
                            <option value="behind">Behind</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Class</label>
                        <select class="form-select" id="classFilter" onchange="applyFilters()">
                            <option value="all">All Classes</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Sort By</label>
                        <select class="form-select" id="sortBy" onchange="applyFilters()">
                            <option value="months_behind_desc">Months Behind ↓</option>
                            <option value="total_owed_desc">Balance ↓</option>
                            <option value="customer_name_asc">Name A-Z</option>
                            <option value="monthly_payment_desc">Monthly Payment ↓</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">View</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="viewMode" id="viewCurrent" value="current" checked>
                            <label class="btn btn-outline-primary" for="viewCurrent">Current</label>
                            <input type="radio" class="btn-check" name="viewMode" id="viewProjections" value="projections">
                            <label class="btn btn-outline-info" for="viewProjections">Projections</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Summary</h5>
            </div>
            <div class="card-body" id="customerSummary">
                <!-- Summary will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Projections Settings (Hidden by default) -->
<div class="row mb-4" id="projectionsSettings" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calendar me-2"></i>Projection Settings</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Time Range</label>
                        <select class="form-select" id="timeRange" onchange="updateProjections()">
                            <option value="6">Next 6 Months</option>
                            <option value="12" selected>Next 12 Months</option>
                            <option value="24">Next 24 Months</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Scenario</label>
                        <select class="form-select" id="scenarioSelect" onchange="updateProjections()">
                            <option value="current">Current Status</option>
                            <option value="restart">If Restarted Today</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Summary Metrics</label>
                        <div class="row text-center">
                            <div class="col-3">
                                <div class="h6 text-info mb-0" id="totalExpectedMonthly">$0</div>
                                <small class="text-muted">Expected Monthly</small>
                            </div>
                            <div class="col-3">
                                <div class="h6 text-success mb-0" id="onTrackCustomers">0</div>
                                <small class="text-muted">On Track</small>
                            </div>
                            <div class="col-3">
                                <div class="h6 text-warning mb-0" id="behindCustomers">0</div>
                                <small class="text-muted">Behind</small>
                            </div>
                            <div class="col-3">
                                <div class="h6 text-primary mb-0" id="avgCompletionMonths">0</div>
                                <small class="text-muted">Avg Completion</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Customer Data Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>
                        <span id="tableTitle">Customer Payment Details</span>
                    </h5>
                    <div class="d-flex gap-2">
                        <span class="text-muted" id="tableInfo">Loading...</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportCurrentView()">
                            <i class="fas fa-download me-1"></i>Export View
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Loading data...</div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead id="tableHead">
                            <!-- Headers will be dynamically populated -->
                        </thead>
                        <tbody id="tableBody">
                            <!-- Table content will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <nav id="pagination" class="mt-3">
                    <!-- Pagination will be generated here -->
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Customer Detail Modal -->
<div class="modal fade" id="customerDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user me-2"></i>
                    Customer Details: <span id="modalCustomerName"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="customerDetailContent">
                <!-- Customer details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportCustomerDetails()">
                    <i class="fas fa-download me-2"></i>Export Customer Data
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let currentData = [];
    let currentProjections = [];
    let currentPage = 1;
    let currentViewMode = 'current';
    const itemsPerPage = 25;
    let currentModalCustomer = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadAvailableClasses();
        setupEventListeners();
        loadCurrentView();
    });

    function setupEventListeners() {
        // Search input with debounce
        let searchTimeout;
        document.getElementById('searchCustomer').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilters, 300);
        });

        // View mode radio buttons
        document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                currentViewMode = this.value;
                toggleViewMode();
            });
        });
    }

    async function loadAvailableClasses() {
        try {
            const response = await fetch('/api/classes');
            const data = await response.json();
            
            const classFilter = document.getElementById('classFilter');
            data.classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classFilter.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading classes:', error);
        }
    }

    function toggleViewMode() {
        const projectionsSettings = document.getElementById('projectionsSettings');
        const tableTitle = document.getElementById('tableTitle');
        
        if (currentViewMode === 'projections') {
            projectionsSettings.style.display = 'block';
            tableTitle.textContent = 'Customer Payment Projections';
            loadProjectionsView();
        } else {
            projectionsSettings.style.display = 'none';
            tableTitle.textContent = 'Customer Payment Details';
            loadCurrentView();
        }
    }

    function toggleProjectionsView() {
        const projectionsRadio = document.getElementById('viewProjections');
        const currentRadio = document.getElementById('viewCurrent');
        
        if (currentViewMode === 'current') {
            projectionsRadio.checked = true;
            currentViewMode = 'projections';
            document.getElementById('toggleProjectionsText').textContent = 'Show Current';
        } else {
            currentRadio.checked = true;
            currentViewMode = 'current';
            document.getElementById('toggleProjectionsText').textContent = 'Show Projections';
        }
        
        toggleViewMode();
    }

    async function loadCurrentView() {
        showLoading(true);
        try {
            await loadCustomerData();
            renderCurrentTable();
            updateSummary();
        } catch (error) {
            console.error('Error loading current view:', error);
            showToast('Error loading customer data', 'danger');
        } finally {
            showLoading(false);
        }
    }

    async function loadProjectionsView() {
        showLoading(true);
        try {
            await loadProjectionData();
            renderProjectionsTable();
            updateProjectionsSummary();
        } catch (error) {
            console.error('Error loading projections view:', error);
            showToast('Error loading projections data', 'danger');
        } finally {
            showLoading(false);
        }
    }

    async function loadCustomerData() {
        const params = new URLSearchParams({
            class_filter: document.getElementById('classFilter').value,
            status_filter: document.getElementById('statusFilter').value,
            search: document.getElementById('searchCustomer').value,
            sort_by: document.getElementById('sortBy').value,
            page: currentPage,
            per_page: itemsPerPage
        });

        const response = await fetch(`/api/customers/data?${params}`);
        const data = await response.json();
        
        currentData = data.data;
        updatePagination(data.pagination);
        updateTableInfo(data.pagination);
    }

    async function loadProjectionData() {
        const timeRange = document.getElementById('timeRange').value;
        const scenario = document.getElementById('scenarioSelect').value;
        const classFilter = document.getElementById('classFilter').value;

        const params = new URLSearchParams({
            months: timeRange,
            scenario: scenario
        });
        
        if (classFilter && classFilter !== 'all') {
            params.append('class_filter', classFilter);
        }

        const response = await fetch(`/api/projections/customers?${params}`);
        currentProjections = await response.json();
        
        // Apply search filter
        const searchTerm = document.getElementById('searchCustomer').value.toLowerCase();
        if (searchTerm) {
            currentProjections = currentProjections.filter(proj => 
                proj.customer_name.toLowerCase().includes(searchTerm)
            );
        }
    }

    function renderCurrentTable() {
        const tableHead = document.getElementById('tableHead');
        const tableBody = document.getElementById('tableBody');
        
        // Set headers
        tableHead.innerHTML = `
            <tr>
                <th>Customer</th>
                <th>Plan ID</th>
                <th>Monthly Payment</th>
                <th>Frequency</th>
                <th>Balance</th>
                <th>% Paid</th>
                <th>Months Behind</th>
                <th>Status</th>
                <th>Class</th>
                <th>Actions</th>
            </tr>
        `;
        
        // Render data
        tableBody.innerHTML = currentData.map(plan => `
            <tr class="${getRowClass(plan)}">
                <td><strong>${plan.customer_name}</strong></td>
                <td><small class="text-muted">${plan.plan_id}</small></td>
                <td><strong>${formatCurrency(plan.monthly_payment || 0)}</strong></td>
                <td><span class="badge bg-info">${plan.frequency || 'monthly'}</span></td>
                <td><strong class="text-success">${formatCurrency(plan.total_owed || 0)}</strong></td>
                <td>
                    <div class="progress" style="height: 15px;">
                        <div class="progress-bar bg-success" style="width: ${plan.percent_paid || 0}%"></div>
                    </div>
                    <small>${(plan.percent_paid || 0).toFixed(1)}%</small>
                </td>
                <td>
                    <span class="${(plan.months_behind || 0) > 0 ? 'text-danger fw-bold' : 'text-muted'}">
                        ${(plan.months_behind || 0).toFixed(1)}
                    </span>
                </td>
                <td>${getStatusBadge(plan.status, plan.months_behind)}</td>
                <td>
                    ${plan.class_field ? `<span class="badge bg-secondary">${plan.class_field}</span>` : '<span class="text-muted">-</span>'}
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="showCustomerDetails('${plan.customer_name}')">
                        <i class="fas fa-eye"></i> Details
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function renderProjectionsTable() {
        const tableHead = document.getElementById('tableHead');
        const tableBody = document.getElementById('tableBody');
        
        // Set headers for projections
        tableHead.innerHTML = `
            <tr>
                <th>Customer</th>
                <th>Status</th>
                <th>Monthly Payment</th>
                <th>Total Owed</th>
                <th>Plans</th>
                <th>Completion</th>
                <th>Next 6 Payments</th>
                <th>Actions</th>
            </tr>
        `;
        
        // Sort projections by priority
        const sortedProjections = currentProjections.sort((a, b) => {
            if (a.renegotiation_needed !== b.renegotiation_needed) {
                return a.renegotiation_needed ? -1 : 1;
            }
            return b.total_monthly_payment - a.total_monthly_payment;
        });
        
        // Render projections data
        tableBody.innerHTML = sortedProjections.map(proj => {
            const statusInfo = getProjectionStatusInfo(proj);
            const nextPayments = getNextPaymentsBadges(proj.timeline);
            
            return `
                <tr class="${statusInfo.rowClass}">
                    <td>
                        <strong>${proj.customer_name}</strong>
                        <br><small class="text-muted">${proj.plan_count} plan${proj.plan_count > 1 ? 's' : ''}</small>
                    </td>
                    <td>${statusInfo.badge}</td>
                    <td>
                        <strong class="text-success">${formatCurrency(proj.total_monthly_payment)}</strong>
                        <br><small class="text-muted">per payment</small>
                    </td>
                    <td><strong>${formatCurrency(proj.total_owed)}</strong></td>
                    <td><span class="badge bg-info">${proj.plan_count}</span></td>
                    <td>
                        <span class="badge ${getCompletionBadgeClass(proj.completion_month)}">
                            ${proj.completion_month > 0 ? `${proj.completion_month} months` : 'Contact needed'}
                        </span>
                    </td>
                    <td>
                        <div class="d-flex flex-wrap gap-1">
                            ${nextPayments}
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showCustomerDetails('${proj.customer_name}')">
                            <i class="fas fa-eye"></i> Details
                        </button>
                        ${proj.renegotiation_needed ? 
                            `<br><button class="btn btn-sm btn-warning mt-1" onclick="exportProjection('${proj.customer_name}')">
                                <i class="fas fa-download"></i> Export
                            </button>` : ''}
                    </td>
                </tr>
            `;
        }).join('');
    }

    function getRowClass(plan) {
        const monthsBehind = plan.months_behind || 0;
        if (monthsBehind >= 3) return 'table-danger';
        if (monthsBehind > 0) return 'table-warning';
        return '';
    }

    function getStatusBadge(status, monthsBehind) {
        const months = monthsBehind || 0;
        
        if (months >= 6) {
            return '<span class="badge bg-danger">Critical</span>';
        } else if (months >= 3) {
            return '<span class="badge bg-warning">Severe</span>';
        } else if (months > 0) {
            return '<span class="badge bg-warning">Behind</span>';
        } else if (status === 'completed') {
            return '<span class="badge bg-info">Completed</span>';
        } else {
            return '<span class="badge bg-success">Current</span>';
        }
    }

    function getProjectionStatusInfo(proj) {
        if (proj.renegotiation_needed) {
            return {
                badge: `<span class="badge bg-danger">Needs Contact</span><br><small class="text-muted">${proj.months_behind} months behind</small>`,
                rowClass: 'table-danger'
            };
        } else if (proj.status === 'behind') {
            return {
                badge: `<span class="badge bg-warning">Behind</span><br><small class="text-muted">${proj.months_behind} months</small>`,
                rowClass: 'table-warning'
            };
        } else if (proj.status === 'restart') {
            return {
                badge: '<span class="badge bg-info">Restart Scenario</span>',
                rowClass: ''
            };
        } else {
            return {
                badge: '<span class="badge bg-success">Current</span>',
                rowClass: ''
            };
        }
    }

    function getCompletionBadgeClass(completionMonth) {
        if (completionMonth <= 0) return 'bg-danger';
        if (completionMonth <= 12) return 'bg-success';
        if (completionMonth <= 24) return 'bg-warning';
        return 'bg-info';
    }

    function getNextPaymentsBadges(timeline) {
        const paymentMonths = timeline
            .filter(month => month.monthly_payment > 0)
            .slice(0, 6)
            .map(month => 
                `<span class="badge bg-success me-1" title="Month ${month.month}: ${formatCurrency(month.monthly_payment)}">${month.month}</span>`
            );
        
        return paymentMonths.length > 0 ? paymentMonths.join('') : '<span class="text-muted">Contact needed</span>';
    }

    async function showCustomerDetails(customerName) {
        try {
            const response = await fetch(`/api/customers/${encodeURIComponent(customerName)}`);
            const customerDetails = await response.json();
            
            currentModalCustomer = customerName;
            document.getElementById('modalCustomerName').textContent = customerName;
            
            const content = document.getElementById('customerDetailContent');
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Customer Information</h6>
                        <ul class="list-unstyled">
                            <li><strong>Total Plans:</strong> ${customerDetails.customer_info.total_plans}</li>
                            <li><strong>Total Open Balance:</strong> ${formatCurrency(customerDetails.customer_info.total_open_balance)}</li>
                            <li><strong>Classes:</strong> ${customerDetails.customer_info.all_classes.join(', ') || 'None'}</li>
                            <li><strong>Multiple Plans:</strong> ${customerDetails.customer_info.has_multiple_plans ? 'Yes' : 'No'}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Payment Plans</h6>
                        ${customerDetails.payment_plans.map(plan => `
                            <div class="card mb-2 ${plan.has_issues ? 'border-danger' : 'border-success'}">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong>${plan.plan_id}</strong><br>
                                            <small>${formatCurrency(plan.monthly_amount)} ${plan.frequency}</small>
                                        </div>
                                        <div class="text-end">
                                            <strong>${formatCurrency(plan.total_open)}</strong><br>
                                            <small class="${plan.has_issues ? 'text-danger' : 'text-success'}">
                                                ${plan.has_issues ? 'Has Issues' : 'Clean'}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                ${customerDetails.metrics.length > 0 ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Payment Metrics</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Plan</th>
                                        <th>Status</th>
                                        <th>% Paid</th>
                                        <th>Months Behind</th>
                                        <th>Projected Completion</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${customerDetails.metrics.map(metric => `
                                        <tr>
                                            <td>${metric.plan_id}</td>
                                            <td><span class="badge bg-${metric.status === 'current' ? 'success' : metric.status === 'behind' ? 'danger' : 'info'}">${metric.status}</span></td>
                                            <td>${metric.percent_paid}%</td>
                                            <td>${metric.months_behind}</td>
                                            <td>${metric.projected_completion || 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('customerDetailModal'));
            modal.show();
            
        } catch (error) {
            console.error('Error loading customer details:', error);
            showToast('Error loading customer details', 'danger');
        }
    }

    function updateSummary() {
        const container = document.getElementById('customerSummary');
        
        if (!currentData.length) {
            container.innerHTML = '<div class="alert alert-info">No data available</div>';
            return;
        }
        
        const totalPlans = currentData.length;
        const behindPlans = currentData.filter(p => (p.months_behind || 0) > 0).length;
        const avgMonthlyPayment = currentData.reduce((sum, p) => sum + (p.monthly_payment || 0), 0) / totalPlans;
        
        container.innerHTML = `
            <div class="row text-center">
                <div class="col-6">
                    <div class="h4 text-primary">${totalPlans}</div>
                    <div class="small text-muted">Total Plans</div>
                </div>
                <div class="col-6">
                    <div class="h4 text-danger">${behindPlans}</div>
                    <div class="small text-muted">Behind</div>
                </div>
            </div>
            <hr>
            <div class="text-center">
                <div class="h5 text-info">${formatCurrency(avgMonthlyPayment)}</div>
                <div class="small text-muted">Avg Monthly</div>
            </div>
        `;
    }

    async function updateProjectionsSummary() {
        try {
            const timeRange = document.getElementById('timeRange').value;
            const scenario = document.getElementById('scenarioSelect').value;
            
            const response = await fetch(`/api/projections/portfolio?months=${timeRange}&scenario=${scenario}`);
            const portfolioData = await response.json();
            
            document.getElementById('totalExpectedMonthly').textContent = formatCurrency(portfolioData.summary.average_monthly);
            document.getElementById('onTrackCustomers').textContent = portfolioData.summary.current_customers;
            document.getElementById('behindCustomers').textContent = portfolioData.summary.behind_customers;
            
            // Calculate average completion
            const avgCompletion = Math.ceil(
                currentProjections.reduce((sum, p) => sum + (p.completion_month || 0), 0) / 
                (currentProjections.length || 1)
            );
            document.getElementById('avgCompletionMonths').textContent = avgCompletion;
            
        } catch (error) {
            console.error('Error updating projections summary:', error);
        }
    }

    function updatePagination(pagination) {
        const container = document.getElementById('pagination');
        
        if (pagination.total_pages <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let html = '<ul class="pagination justify-content-center">';
        
        if (pagination.has_prev) {
            html += `<li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${pagination.current_page - 1})">Previous</a>
                    </li>`;
        }
        
        const startPage = Math.max(1, pagination.current_page - 2);
        const endPage = Math.min(pagination.total_pages, pagination.current_page + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            html += `<li class="page-item ${i === pagination.current_page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>`;
        }
        
        if (pagination.has_next) {
            html += `<li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${pagination.current_page + 1})">Next</a>
                    </li>`;
        }
        
        html += '</ul>';
        container.innerHTML = html;
    }

    function updateTableInfo(pagination) {
        document.getElementById('tableInfo').textContent = 
            `Showing ${pagination.start_index || 1}-${pagination.end_index || 0} of ${pagination.total_items || 0}`;
    }

    function changePage(page) {
        currentPage = page;
        loadCurrentView();
    }

    function applyFilters() {
        currentPage = 1;
        loadCurrentView();
    }

    function clearSearch() {
        document.getElementById('searchCustomer').value = '';
        applyFilters();
    }

    async function updateProjections() {
        if (currentViewMode === 'projections') {
            await loadProjectionsView();
        }
    }

    function showLoading(show) {
        document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
    }

    async function refreshData() {
        showToast('Refreshing data...', 'info');
        if (currentViewMode === 'current') {
            await loadCurrentView();
        } else {
            await loadProjectionsView();
        }
        showToast('Data refreshed', 'success');
    }

    async function downloadCustomerData() {
        try {
            const response = await fetch('/api/download/excel');
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'customer_payment_data.xlsx';
                a.click();
                window.URL.revokeObjectURL(url);
                showToast('Customer data exported successfully', 'success');
            } else {
                throw new Error('Export failed');
            }
        } catch (error) {
            console.error('Export error:', error);
            showToast('Error exporting data', 'danger');
        }
    }

    async function exportProjection(customerName) {
        try {
            const timeRange = document.getElementById('timeRange').value;
            const scenario = document.getElementById('scenarioSelect').value;
            
            const response = await fetch(`/api/download/customer-projection/${encodeURIComponent(customerName)}?months=${timeRange}&scenario=${scenario}`);
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${customerName.replace(/\s+/g, '_')}_projection.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                showToast('Projection exported successfully', 'success');
            } else {
                throw new Error('Export failed');
            }
        } catch (error) {
            console.error('Export error:', error);
            showToast('Error exporting projection', 'danger');
        }
    }

    function exportCurrentView() {
        if (currentViewMode === 'current') {
            downloadCustomerData();
        } else {
            // Export collections CSV for projections view
            fetch('/api/download/collections-csv')
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'customer_projections.csv';
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showToast('Projections exported successfully', 'success');
                })
                .catch(error => {
                    console.error('Export error:', error);
                    showToast('Error exporting projections', 'danger');
                });
        }
    }

    function exportCustomerDetails() {
        if (currentModalCustomer) {
            // Export specific customer projection
            exportProjection(currentModalCustomer);
        }
    }

    // Utility functions
    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(amount);
    }

    function showToast(message, type) {
        console.log(`${type.toUpperCase()}: ${message}`);
        // Use existing toast system if available
    }
</script>
{% endblock %}